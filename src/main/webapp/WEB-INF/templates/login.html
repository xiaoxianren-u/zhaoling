<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" th:href="@{/static/css/layui.css}">
    <script th:src="@{/static/js/layui.js}"></script>
    <script th:src="@{/static/js/md5.js}"></script>
    <script th:src="@{/static/js/jquery-3.5.1.min_2.js}"></script>
    <script th:src="@{/static/js/jquery.cookie.js}"></script>

    <style type="text/css">
        body {
            background-size: cover;
            background-color: #e3e0e0;
        }

        #home {
            width: 25%;
            height: 450px;
            margin-left: 57%;
            margin-top: 12%;
            color: #479b9b;
            background-color: white;
            border-radius: 10px;
        }

        .inp {
            width: 100%;
            line-height: 40px;
            margin: 10px 0;
            font-size: 20px;
            border: 1px solid #13c9a3;
            border-radius: 8px;
        }

        #username, #password {
            text-indent: 1.5em;
        }

        #btn {
            background: #979898;
            border: 1px #979898 solid;
        }

        #yzm {
            width: 55%;
            text-indent: 1em;
        }

        #btn:hover {
            cursor: pointer;
            border: 1px #13c9a3 solid;
            background: #13c9a3;
            color: white;
        }

        #img {
            float: right;
            margin: 5px;
            border-radius: 10px;
            border: 1px #13c9a3 solid;
        }

        #img:hover {
            cursor: pointer;
        }
    </style>

</head>
<body>
<div id="home">


    <div class="layui-row">
        <div class="layui-col-xs6" style="margin-top: 20px;">
            <div class="grid-demo grid-demo-bg1"><span style="font-size: 20px;margin-left: 20px">账号登录</span></div>
        </div>
        <div class="layui-col-xs6">
            <div class="grid-demo" style="color:white;">6/12</div>
        </div>
    </div>
    <div class="layui-row" style="padding-top: 30px;">
        <div class="layui-col-xs1">
            <div class="grid-demo grid-demo-bg1" style="color:white;">6/12</div>
        </div>
        <div class="layui-col-xs10">
            <div class="grid-demo">
                <form action="login" id="myForm" method="post">
                    <input class="inp" id="username" name="username" type="text" value=""/>
                    <input class="inp" id="password" name="password" type="password" value=""/>

                    <input class="inp" id="yzm" placeholder="验证码" type="text"/>
                    <img id="img" onclick="changeImg()" src="getCode">

                    <div style="margin: 10px;">
                        <span><input id="rememberMe" style="margin-right: 5px;margin-top: 3px" type="checkbox"><label
                                for="rememberMe">记住密码</label></span>
                        <span style="font-size: 2pt;color: #bbb;">不是自己的电脑上不要勾选此项</span>
                        <span style="float: right;"><input id="autoLogin" style="margin-right: 5px;"
                                                           type="checkbox"><label
                                for="autoLogin">一周内免登录</label></span>
                    </div>
                    <button class="inp" id="btn" type="button">立即登录</button>
                </form>
                <div>
                    <span><a href="http://www.baidu.com" style="float: left;color: #1E9FFF">注册?</a></span>
                    <span><a href="#" style="float: right;color: #1E9FFF;">忘记密码?</a></span>
                </div>
            </div>
        </div>
        <div class="layui-col-xs1">
            <div class="grid-demo" style="color:white;">6/12</div>
        </div>
    </div>


</div>

<script th:inline="none" type="text/javascript">


    //点击更换验证码
    function changeImg() {
        const imgSrc = $("#img");
        const src = imgSrc.attr("src");
        imgSrc.attr("src", chgUrl(src));
    }

    // 时间戳
    // 为了使每次生成图片不一致，即不让浏览器读缓存，所以需要加上时间戳
    function chgUrl(url) {
        const timestamp = (new Date()).valueOf();
        url = url.substring(0, 20);
        if ((url.indexOf("&") >= 0)) {
            url = url + "×tamp=" + timestamp;
        } else {
            url = url + "?timestamp=" + timestamp;
        }
        return url;
    }

    //登录
    $("#btn").click(function () {
        const yzm = $("#yzm").val();
        $.get("yz?yzm=" + yzm, function (src) {
            console.log(src);
            if (src.bool) {
                login();
            } else {
                alert("验证码输入正确！")
            }
        })
    })
    //监听回车事件
    $('#myForm').bind('keyup', function (event) {
        if (event.keyCode === "13") {
            $('#btn').click();
        }
    });

    function login() {
        let username = $("#username").val();
        let password = $("#password").val();
        const yan = '!a@n%p&';
        password = md5(yan + password + yan);
        let time = 1;
        if ($("#autoLogin").prop("checked")) {
            time = 7;
        }
        $.ajax({
            type: "POST",
            url: "/login",
            async: true,
            data: JSON.stringify({user_name: username, pass_word: password, status: "1", user_id: time}),
            dataType: "json",
            contentType: "application/json;charset=UTF-8",
            success: function (src) {
                if (src.bool) {
                    document.cookie = src.token;
                    Save(src.token);
                    window.location = "/sys/index.action";
                } else {
                    alert(src.msg)
                }
            }

        })
    }


    function Save(token) {
        if ($("#rememberMe").prop("checked")) {
            let username = $("#username").val();//用户名
            let password = $("#password").val();//密码
            $.cookie("rmbUser", "true", {expires: 7}); //存储一个带7天期限的cookie
            $.cookie("username1", username, {expires: 7});
            $.cookie("password1", password, {expires: 7});
            console.log("===========");
        } else {
            $.cookie("rmbUser", "false", {expire: -1});
            $.cookie("username", "", {expires: -1});
            $.cookie("password", "", {expires: -1});
        }

        //当狗选免登陆时存储用户名密码及token
        if ($("#autoLogin").prop("checked")) {
            let username = $("#username").val();
            let password = $("#password").val();
            $.cookie("auto", "true", {expires: 7}); //存储一个带7天期限的cookie
            $.cookie("username", username, {expires: 7});
            $.cookie("password", password, {expires: 7});
            $.cookie("toke", token, {expires: 1});
        } else {
            $.cookie("auto", "false", {expire: -1});
            $.cookie("username", "", {expires: -1});
            $.cookie("password", "", {expires: -1});
        }
    }

    // 判断 免登陆是否打钩
    $(document).ready(function () {
        $("#autoLogin").change(function () {
            if ($("#autoLogin").prop("checked")) {
                $.cookie("auto", "true", {expires: 7});
            } else {
                $.cookie("auto", "false", {expires: 7});
            }
        });

        //记住密码 回显
        if ($.cookie("rmbUser") === "true") {
            $("#rememberMe").attr("checked", true);
            $("#username").val($.cookie("username1"));
            $("#password").val($.cookie("password1"));
        }


        //一天免登陆
        if ($.cookie("auto") === "true") {
            $("#autoLogin").attr("checked", true);
            setTimeout(function () {
                if ($.cookie("auto") === "true") {
                    document.cookie = $.cookie("toke");
                    window.location.href = '/sys/index.action';
                } else {
                    $.cookie("toke", "");
                }
            }, 8000);
        } else {
            $.cookie("toke", "");
        }
    });


</script>

</body>
</html>
