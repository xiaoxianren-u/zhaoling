<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" th:href="@{/static/css/layui.css}">
    <script th:src="@{/static/js/layui.js}"></script>
    <script th:src="@{/static/js/md5.js}"></script>
    <script th:src="@{/static/js/jquery-3.5.1.min_2.js}"></script>
    <script th:src="@{/static/js/jquery.cookie.js}"></script>
    <link rel="stylesheet" th:href="@{/static/icon_1/iconfont.css}">
    <style type="text/css">
        body {
            background-size: cover;
            background-color: #1E9FFF;
        }

        #home {
            width: 25%;
            height: 450px;
            margin-left: 57%;
            margin-top: 12%;
            color: #479b9b;
            background-color: white;
            border-radius: 10px;
            filter: alpha(opacity=30);
            opacity: 0.8;
            -moz-opacity: 0.8;;
        }

        .inp {
            width: 100%;
            line-height: 40px;
            margin: 10px 0;
            font-size: 20px;
            border: 1px solid #13c9a3;
            border-radius: 8px;
        }

        #username, #password {
            text-indent: 1.5em;
        }

        #btn {
            background: #979898;
            border: 1px #979898 solid;
        }

        #yzm {
            width: 55%;
            text-indent: 1.5em;
        }

        #btn:hover {
            cursor: pointer;
            border: 1px #13c9a3 solid;
            background: #13c9a3;
            color: white;
        }

        #img {
            float: right;
            margin: 5px;
            border-radius: 10px;
            border: 1px #13c9a3 solid;
        }

        #img:hover {
            cursor: pointer;
        }
    </style>
    <script th:src="@{static/icon_1/iconfont.js}"></script>

</head>
<body>

<div>
    <div id="home" style="z-index: 99;position:absolute;top:0;left:0;">


        <div class="layui-row">
            <div class="layui-col-xs6" style="margin-top: 20px;">
                <div class="grid-demo grid-demo-bg1"><span style="font-size: 20px;margin-left: 20px">账号登录</span></div>
            </div>
            <div class="layui-col-xs6">
                <div class="grid-demo" style="color:white;">.</div>
            </div>
        </div>
        <div class="layui-row" style="padding-top: 30px;">
            <div class="layui-col-xs1">
                <div class="grid-demo grid-demo-bg1" style="color:white;">.</div>
            </div>
            <div class="layui-col-xs10">
                <div class="grid-demo">
                    <form action="login" id="myForm" method="post">
                        <i class="iconfont icon-yonghuming"
                           style="font-size: 20px; color:#13c9a3; z-index: 999999;position:absolute;top: 20px;left: 6px; "></i>
                        <input class="inp" id="username" name="username" type="text" value=""/>
                        <i class="iconfont icon-mima"
                           style="font-size: 20px; color: #13c9a3;z-index: 999999;position:absolute;top: 82px;left: 6px; "></i>
                        <input class="inp" id="password" name="password" type="password" value=""/>

                        <i class="iconfont icon-yanzhengma"
                           style="font-size: 20px; color: #13c9a3;z-index: 999999;position:absolute;top: 145px;left: 6px; "></i>
                        <input class="inp" id="yzm" placeholder="验证码" type="text"/>
                        <img id="img" onclick="changeImg()" src="getCode">

                        <div style="margin: 10px;">
                        <span><input id="rememberMe" style="margin-right: 5px;margin-top: 3px" type="checkbox"><label
                                for="rememberMe">记住密码</label></span>
                            <span style="font-size: 2pt;color: #bbb;">不是自己的电脑上不要勾选此项</span>
                            <span style="float: right;"><input id="autoLogin" style="margin-right: 5px;"
                                                               type="checkbox"><label
                                    for="autoLogin">一周内免登录</label></span>
                        </div>
                        <button class="inp" id="btn" type="button">立即登录</button>
                    </form>
                    <div>
                        <span><a href="http://www.baidu.com" style="float: left;color: #1E9FFF">注册?</a></span>
                        <span><a href="#" style="float: right;color: #1E9FFF;">忘记密码?</a></span>
                    </div>
                </div>
            </div>
            <div class="layui-col-xs1">
                <div class="grid-demo" style="color:white;">6/12</div>
            </div>
        </div>


    </div>
    <div style="width: 100%;height: 900px">
        <canvas height="" id="cas" style="z-index: -1" width=""></canvas>
    </div>
</div>

<script th:inline="none" type="text/javascript">

    //点击更换验证码
    function changeImg() {
        const imgSrc = $("#img");
        const src = imgSrc.attr("src");
        imgSrc.attr("src", chgUrl(src));
    }

    // 时间戳
    // 为了使每次生成图片不一致，即不让浏览器读缓存，所以需要加上时间戳
    function chgUrl(url) {
        const timestamp = (new Date()).valueOf();
        url = url.substring(0, 20);
        if ((url.indexOf("&") >= 0)) {
            url = url + "×tamp=" + timestamp;
        } else {
            url = url + "?timestamp=" + timestamp;
        }
        return url;
    }

    //登录
    $("#btn").click(function () {
        const yzm = $("#yzm").val();
        $.get("yz?yzm=" + yzm, function (src) {
            console.log(src);
            if (src.bool) {
                login();
            } else {
                alert("验证码输入正确！")
            }
        })
    })
    //监听回车事件
    $('#myForm').bind('keyup', function (event) {
        if (event.keyCode === "13") {
            $('#btn').click();
        }
    });

    function login() {
        let username = $("#username").val();
        let password = $("#password").val();
        const yan = '!a@n%p&';
        password = md5(yan + password + yan);
        let time = 1;
        if ($("#autoLogin").prop("checked")) {
            time = 7;
        }
        $.ajax({
            type: "POST",
            url: "/login",
            async: true,
            data: JSON.stringify({user_name: username, pass_word: password, status: "1", user_id: time}),
            dataType: "json",
            contentType: "application/json;charset=UTF-8",
            success: function (src) {
                if (src.bool) {
                    document.cookie = src.token;
                    Save(src.token);
                    window.location = "/sys/index.action";
                } else {
                    alert(src.msg)
                }
            }

        })
    }


    function Save(token) {
        if ($("#rememberMe").prop("checked")) {
            let username = $("#username").val();//用户名
            let password = $("#password").val();//密码
            $.cookie("rmbUser", "true", {expires: 7}); //存储一个带7天期限的cookie
            $.cookie("username1", username, {expires: 7});
            $.cookie("password1", password, {expires: 7});
            console.log("===========");
        } else {
            $.cookie("rmbUser", "false", {expire: -1});
            $.cookie("username", "", {expires: -1});
            $.cookie("password", "", {expires: -1});
        }

        //当狗选免登陆时存储用户名密码及token
        if ($("#autoLogin").prop("checked")) {
            let username = $("#username").val();
            let password = $("#password").val();
            $.cookie("auto", "true", {expires: 7}); //存储一个带7天期限的cookie
            $.cookie("username", username, {expires: 7});
            $.cookie("password", password, {expires: 7});
            $.cookie("toke", token, {expires: 1});
        } else {
            $.cookie("auto", "false", {expire: -1});
            $.cookie("username", "", {expires: -1});
            $.cookie("password", "", {expires: -1});
        }
    }

    // 判断 免登陆是否打钩
    $(document).ready(function () {
        $("#autoLogin").change(function () {
            if ($("#autoLogin").prop("checked")) {
                $.cookie("auto", "true", {expires: 7});
            } else {
                $.cookie("auto", "false", {expires: 7});
            }
        });

        //记住密码 回显
        if ($.cookie("rmbUser") === "true") {
            $("#rememberMe").attr("checked", true);
            $("#username").val($.cookie("username1"));
            $("#password").val($.cookie("password1"));
        }


        //一天免登陆
        if ($.cookie("auto") === "true") {
            $("#autoLogin").attr("checked", true);
            setTimeout(function () {
                if ($.cookie("auto") === "true") {
                    document.cookie = $.cookie("toke");
                    window.location.href = '/sys/index.action';
                } else {
                    $.cookie("toke", "");
                }
            }, 8000);
        } else {
            $.cookie("toke", "");
        }
    });


</script>

<!--实现颗粒线背景-->
<script>
    var canvas = document.getElementById("cas");
    var ctx = canvas.getContext("2d");

    resize();
    window.onresize = resize;

    function resize() {
        canvas.width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        canvas.height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    }

    var RAF = (function () {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (callback) {
            window.setTimeout(callback, 1000 / 60);
        };
    })();

    // 鼠标活动时，获取鼠标坐标
    var warea = {x: null, y: null, max: 20000};
    window.onmousemove = function (e) {
        e = e || window.event;

        warea.x = e.clientX;
        warea.y = e.clientY;
    };
    window.onmouseout = function (e) {
        warea.x = null;
        warea.y = null;
    };

    // 添加粒子
    // x，y为粒子坐标，xa, ya为粒子xy轴加速度，max为连线的最大距离
    var dots = [];
    for (var i = 0; i < 450; i++) {
        var x = Math.random() * canvas.width;
        var y = Math.random() * canvas.height;
        var xa = Math.random() * 2 - 1;
        var ya = Math.random() * 2 - 1;

        dots.push({
            x: x,
            y: y,
            xa: xa,
            ya: ya,
            max: 7000
        })
    }

    // 延迟100秒开始执行动画，如果立即执行有时位置计算会出错
    setTimeout(function () {
        animate();
    }, 100);

    // 每一帧循环的逻辑
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 将鼠标坐标添加进去，产生一个用于比对距离的点数组
        var ndots = [warea].concat(dots);
        dots.forEach(function (dot) {
            // 粒子位移
            dot.x += dot.xa;
            dot.y += dot.ya;
            // 遇到边界将加速度反向
            dot.xa *= (dot.x > canvas.width || dot.x < 0) ? -1 : 1;
            dot.ya *= (dot.y > canvas.height || dot.y < 0) ? -1 : 1;
            // 绘制点
            ctx.fillRect(dot.x - 0.5, dot.y - 0.5, 1, 1);
            // 循环比对粒子间的距离
            for (var i = 0; i < ndots.length; i++) {
                var d2 = ndots[i];
                if (dot === d2 || d2.x === null || d2.y === null) continue;
                var xc = dot.x - d2.x;
                var yc = dot.y - d2.y;
                // 两个粒子之间的距离
                var dis = xc * xc + yc * yc;
                // 距离比
                var ratio;
                // 如果两个粒子之间的距离小于粒子对象的max值，则在两个粒子间画线
                if (dis < d2.max) {
                    // 如果是鼠标，则让粒子向鼠标的位置移动
                    if (d2 === warea && dis > (d2.max / 2)) {
                        dot.x -= xc * 0.03;
                        dot.y -= yc * 0.03;
                    }
                    // 计算距离比
                    ratio = (d2.max - dis) / d2.max;
                    // 画线
                    ctx.beginPath();
                    ctx.lineWidth = ratio / 2;
                    //线条颜色
                    ctx.strokeStyle = 'rgba(255,255,255,' + (ratio + 0.3) + ')';
                    ctx.moveTo(dot.x, dot.y);
                    ctx.lineTo(d2.x, d2.y);
                    ctx.stroke();
                }
            }
            // 将已经计算过的粒子从数组中删除
            ndots.splice(ndots.indexOf(dot), 1);
        });
        RAF(animate);
    }
</script>

<!--检测Cookie是否打开-->
<script>
    function CookieEnable() {
        var result = false;
        if (navigator.cookiesEnabled) return true;
        document.cookie = "testcookie=yes;";
        var cookieSet = document.cookie;
        if (cookieSet.indexOf("testcookie=yes") > -1) result = true;
        document.cookie = "";
        return result;
    }

    if (!CookieEnable()) {
        alert("检测您的浏览器Cookie已经关闭，您将可能无法正常使用该网站，请到设置中打开Cookie")
    }
</script>

</body>
</html>
